## 第3章 基于YOLO v3模型的实时目标检测系统

相比于传统的人工检查口罩佩戴的方式，采用实时目标检测系统可以节省人力，同时减少不必要的接触，还可以配合人脸识别系统进行登记，统计各类人群在公共场所的口罩佩戴情况。但在实际情况中，人们会佩戴各式各样的口罩，脸部可能还会有其他的遮挡物如眼镜，帽子，手机等，在公共场所中，人群也会相互遮挡，不同人还会有不同的行走速度，这些情况容易造成漏检漏检，这就要求我们的目标检测算法能够在复杂的情况下有较快检测速度，同时又能有更高的检测精度。

YOLO v3 模型是 YOLO 模型的第三个版本，针对前两版的问题，引入了残差结构块，减少了卷积的参数冗余，一定程度上减少了梯度消失和梯度爆炸的情况，优化了网络的总体结构；同时改进了不同尺度的目标检测，在 YOLO v3 模型的三个尺度中，最小的 13×13 尺度的特征图负责检测大目标，中间的 26×26 尺度的特征图负责检测中等大小的目标，最大的 52x52 尺度的特征图负责检测小目标。这样的多尺度的检测很适合针对口罩佩戴情况进行检测，既可以作为门禁刷脸判断是否佩戴口罩决定是否放行，也可采集公共场所的人群口罩佩戴情况继而有针对性进行防疫工作。利用 YOLO v3 模型，我们不必先定位人脸后再根据人脸的口鼻部分进行目标检测，YOLO v3 是单步（one stage）算法，通过将输入图像归一化为统一的尺寸，然后将图像分解成奇数的平方个区域，在每个区域使用卷积神经网络提取特征，生成预测框，只做一次边框回归，通过非极大值抑制算法直接可以得到最终的目标框，这样便能达到实时检测的要求同时也有不俗的检测精度。

### 3.1 项目准备

利用 YOLO v3 模型我们可以利用初始权重对数据集进行预训练，继而得到训练若干批次后权重文件，利用权重文件对输入的视频流进行实时的目标检测。在本章所要实现的目标检测系统中，主要识别目标是口罩佩戴情况，如图3.1 所示共分为三种情况：未佩戴口罩，标签为 none；未正确佩戴口罩，标签为 bad；正确佩戴口罩，标签为 good。我们会对三种情况进行检测并输出结果。本章所使用的数据集中的图像全部收集于网络，通过使用标注软件对图像进行标注，之后整理图像和标注文件，制作成标准的 VOC 数据集后再进行训练。训练所用的代码是 YOLO 论文作者 J.Redmon 的 darknet，初始权重文件也是从作者的个人网站上下载的。

![图3.1 人群口罩佩戴情况](https://ufile.freewisdom.cn/resources/605a0101/classes.png)

<center>图3.1 人群口罩佩戴情况</center>

### 3.2 预训练

#### 3.2.1 数据集

从网络上共采集到 600 张图片，进过筛选后共取 540 张图片作为原始图像，这些图像主要是 2020 年新冠疫情期间的相关新闻报道的图像，也有很多卖口罩的网店的模特宣传图。采集到的图像使用 LabelImg 程序进行标注，会得到的和图像同名的的 xml 文件，这种格式符合 VOC 数据集规范，之后使用 python 脚本将 xml 文件转化为 YOLO 模型能识别的归一化后的 txt 文件。因样本数目较少，所以收集到的所有图像全部用于进行预训练。

#### 3.2.2 配置及代码

预训练部分的目录结构如图3.2 所示，其中训练集（train.txt）包含了所有图像。网络配置文件的 classes 设为 3，三个尺度的最后一个卷积层的 filters 设为 24，训练批次设为 20000，其他参数较代码仓库中的原文件不做改变。类别名称包含 none, bad, good 三种。配置中的路径均采用绝对路径，数据集的 txt 文件中的路径为相对路径。

![图3.2 预训练的目录结构](https://ufile.freewisdom.cn/resources/605a0101/train-stages.png)

<center>图3.2 预训练的目录结构</center>

#### 3.2.3 训练过程

预训练的采用环境如下：CPU 型号为 Intel(R) Xeon(R) Gold 5218 CPU，使用的核心数为 16，内存 64G，硬盘为 1TB 的 SSD；显卡为 Nvidia GeForce RTX 2080Ti，该显卡的显存为 11G。使用 darknet 进行模型的预训练，约 6 分钟训练 100 批次，共计训练了 21 小时，最后取用最终的权重文件以及 10000 批次时的权重文件。


### 3.3 项目成果

为了利用 darknet 训练网络后得到的权重文件，本项目将使用 python 代码完成一个实时目标检测系统，主要使用 tensorflow 2.4 开源深度学习框架，配合 opencv 实现实时的口罩佩戴检测。

首先，利用 convert.py 将权重文件转化为 tensorflow 能够识别的权重格式。之后，使用 keras 提供的 tensorflow 接口构建 YOLO v3 模型的网络结构。最后结合 opencv 读取实时视频流并且对视频帧进行目标检测。总体流程见图3.3。

![图3.3 程序总体流程图](https://ufile.freewisdom.cn/resources/605a0101/program-flow.png)

<center>图3.3 程序总体流程图</center>

本项目最终完成的程序能够在本人的笔记本电脑上以 5 帧的速率检测摄像头读入的视频流，如图3.4 所示能够有良好的检测效果，同时本程序也可以切换视频流来源，以实现对视频文件的人进行口罩佩戴检测，或者检测单张图像。

![图3.4 检测效果图](https://ufile.freewisdom.cn/resources/605a0101/results.png)

<center>图3.4 检测效果图</center>

### 3.4 项目展望

虽能程序能够很好的实现实时检测，但针对本文描述的实际场景，还有很多问题需要解决，本章项目最终的程序需要更进一步的改进与优化。主要有以下几个方面：
（1）预训练和检测系统的代码以及操作方法没有统一，使用起来不方便。使用 c 语言实现的 darknet 进行的网络训练，使用 python 实现实时目标检测，两种语言之间有通用的接口让训练与检测统一，也可以单独使用 python 的 tensorflow 框架实现训练与检测。下一步的研究可以灵活选择语言与框架，让训练和检测更易用，程序的设计上可以根据不同的场景使用不同的神经网络结构，在特定场景可以舍弃一些精度提高检测速度，在检测部分，可以使用多进程将读取视频流与检测分开，加快检测速度；还可以设计用户交互界面，方便目标检测系统的部署与利用。
（2）数据集，一个良好的数据集能让最终的检测效果更好，本章中所用的样本数据集只有 540 个图像数据，且训练时没有使用旋转、裁剪拼接等方法对数据集进行扩充，导致程序不够通用化；数据集中三个类别的样本比例不平衡，bad 类的样本数量特别少，而且 bad 的标准是根据样本集中的情况自行制定的，bad 标准需要系统的描述与规定。因此下一步研究中的需要选择更多数量和更加通用的人脸数据集和口罩数据集，有必要时还需寻求志愿者生成合适的样本，以获得尽可能多的口罩佩戴情况，同时可以利用图像处理技术扩充数据集，使得程序的鲁棒性更强。数据集中还需要设置测试集，方便对训练结果进行评价。
（3）基于 YOLO 模型的目标检测系统具有很大的应用前景，本章只实现了一个口罩佩戴检测系统最基础的部分，应用场景十分有限。对于 YOLO v3 模型，已经有许多学者对其进行了改进，在下一步的研究计划中，可以对模型进行改进，例如改进目标框损失，这样不但可以优化网络结构，还可以加快网络的收敛速度，同时使得程序能够有更好的检测效果。在下一章中，本文将探讨 YOLO v3 模型的目标框损失改进。
